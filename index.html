<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<title>Uang Keluarga</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon192.png">
<meta name="theme-color" content="#f59e0b">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,sans-serif;
  background:#fff7ed;
  color:#1f2937;
}
header{
  text-align:center;
  padding:14px;
  font-size:18px;
  font-weight:700;
  background:#fff;
  border-bottom:1px solid #e5e7eb;
}
.container{
  max-width:480px;
  margin:auto;
  padding:14px;
  padding-bottom:90px;
}
.card{
  background:#fff;
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.06);
}
label{font-size:12px;color:#6b7280}
input,textarea,select{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  margin-bottom:10px;
  font-size:14px;
}
.amount{font-size:20px;font-weight:700}
button{
  border:none;
  border-radius:10px;
  padding:10px;
  font-weight:700;
  cursor:pointer;
}

.toggle{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.toggle button{
  flex:1;
  background:#fde68a;
  color:#92400e;
}
.toggle button.active{
  background:#f59e0b;
  color:#fff;
}

/* History */
.row{
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.left .date{font-size:11px;color:#9ca3af}
.left .note{font-size:16px;font-weight:600}
.left .cat{
  font-size:11px;
  background:#fde68a;
  padding:2px 8px;
  border-radius:999px;
  display:inline-block;
}
.right{text-align:right}
.right .amt{font-size:18px;font-weight:700}
.right .actions button{
  padding:4px 6px;
  font-size:12px;
  margin-left:4px;
  background:#e5e7eb;
}

/* Nav */
.nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  display:flex;
  background:#fff;
  border-top:2px solid #e5e7eb;
}
.nav button{
  flex:1;
  padding:12px;
  background:none;
  border:none;
  font-weight:600;
  color:#6b7280;
}
.nav button.active{
  color:#f59e0b;
  border-top:3px solid #f59e0b;
}
.hidden{display:none}
.empty{
  text-align:center;
  color:#9ca3af;
  padding:30px 0;
}
</style>
</head>

<body>
<header>üí∞ Uang Keluarga üí∞</header>

<div class="container">

<!-- TAB INPUT -->
<div id="tabInput">
  <div class="card">
    <label>Tanggal</label>
    <input type="date" id="date">

    <div class="toggle">
      <button id="btnOut" class="active">Pengeluaran</button>
      <button id="btnIn">Pemasukan</button>
    </div>

    <label>Catatan</label>
    <textarea id="note" rows="2"></textarea>

    <label>Nominal</label>
    <input id="amount" type="number" class="amount">

    <label>Kategori</label>
    <select id="category">
      <option>Makan</option>
      <option>Transport</option>
      <option>Rumah</option>
      <option>Anak</option>
      <option>Pemasukan</option>
      <option>Lainnya</option>
    </select>

    <button style="background:#f59e0b;color:#fff" onclick="save()">Simpan</button>
  </div>
</div>

<!-- TAB RIWAYAT -->
<div id="tabHistory" class="hidden"></div>

<!-- TAB INSIGHT -->
<div id="tabInsight" class="hidden">
  <div class="card" id="insightBox"></div>

  <div class="card">
    <button 
      style="background:#e5e7eb;color:#1f2937;width:100%"
      onclick="exportCSV()">
      üì§ Export CSV
    </button>
  </div>
</div>

</div>

<div class="nav">
  <button class="active" onclick="switchTab('input',this)">Input</button>
  <button onclick="switchTab('history',this)">Riwayat</button>
  <button onclick="switchTab('insight',this)">Insight</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "15986435670",
  authDomain: "keuangan-keluarga-86811.firebaseapp.com",
  projectId: "keuangan-keluarga-86811",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = collection(db, "keluarga");

let type="out", editId=null;

// default date
date.valueAsDate=new Date();

// toggle
btnOut.onclick=()=>setType("out");
btnIn.onclick=()=>setType("in");

function setType(t){
  type=t;
  btnOut.classList.toggle("active",t==="out");
  btnIn.classList.toggle("active",t==="in");
}

// auto category
note.oninput=()=>{
  const t=note.value.toLowerCase();
  if(/makan|kopi|ayam|nasi/.test(t)) category.value="Makan";
  else if(/bensin|ojek|parkir/.test(t)) category.value="Transport";
  else if(/listrik|air|internet/.test(t)) category.value="Rumah";
  else if(/anak|susu|popok/.test(t)) category.value="Anak";
  else if(/gaji|thr|jual/.test(t)) category.value="Pemasukan";
  else category.value="Lainnya";
};

// save
window.save=async()=>{
  if(!amount.value) return alert("Nominal wajib diisi");

  const payload={
    date:date.value,
    note:note.value||"-",
    category:category.value,
    type,
    amount:+amount.value,
    created:serverTimestamp()
  };

  if(editId){
    await updateDoc(doc(db,"keluarga",editId),payload);
    editId=null;
  }else{
    await addDoc(ref,payload);
  }
  reset();
};

function reset(){
  note.value="";amount.value="";
  category.value="Lainnya";
  date.valueAsDate=new Date();
  setType("out");
}

// realtime render
onSnapshot(ref,snap=>{
  let inc=0,exp=0,cat={};
  tabHistory.innerHTML="";
  if(snap.empty){
    tabHistory.innerHTML=`<div class="empty">Belum ada catatan</div>`;
  }

window._lastSnapshot = [];
  snap.docs.sort((a,b)=>b.data().date.localeCompare(a.data().date))
  .forEach(d=>{
    const t=d.data(); const id=d.id;
    if(t.type==="in") inc+=t.amount; else exp+=t.amount;
    cat[t.category]=(cat[t.category]||0)+t.amount;
window._lastSnapshot.push(t);

    tabHistory.innerHTML+=`
    <div class="card row">
      <div class="left">
        <div class="date">${t.date}</div>
        <div class="note">${t.note}</div>
        <div class="cat">${t.category}</div>
      </div>
      <div class="right">
        <div class="amt">${t.type==="out"?"-":"+"}${t.amount.toLocaleString()}</div>
        <div class="actions">
          <button onclick="edit('${id}')">‚úèÔ∏è</button>
          <button onclick="del('${id}')">üóë</button>
        </div>
      </div>
    </div>`;
  });

  insightBox.innerHTML=`
    <b>Pemasukan:</b> Rp ${inc.toLocaleString()}<br>
    <b>Pengeluaran:</b> Rp ${exp.toLocaleString()}<br>
    <b>Saldo:</b> Rp ${(inc-exp).toLocaleString()}<hr>
    ${Object.entries(cat).map(([k,v])=>`${k}: Rp ${v.toLocaleString()}`).join("<br>")}
  `;
});

window.edit=(id)=>{
  editId=id;
  switchTab("input",document.querySelector(".nav button"));
};
window.del=async(id)=>{
  if(confirm("Hapus data ini?")) await deleteDoc(doc(db,"keluarga",id));
};

window.switchTab=(tab,btn)=>{
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  tabInput.classList.toggle("hidden",tab!=="input");
  tabHistory.classList.toggle("hidden",tab!=="history");
  tabInsight.classList.toggle("hidden",tab!=="insight");
};

window.exportCSV = () => {
  if (!window._lastSnapshot || window._lastSnapshot.length === 0) {
    alert("Belum ada data untuk diexport");
    return;
  }

  let csv = "Tanggal,Catatan,Kategori,Tipe,Nominal\n";

  window._lastSnapshot.forEach(t => {
    csv += `${t.date},"${t.note.replace(/"/g,'""')}",${t.category},${t.type},${t.amount}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "uang-keluarga.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

</script>

<script>
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
